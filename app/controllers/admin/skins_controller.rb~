require 'fileutils'
class Admin::SkinsController < ApplicationController
	def index
		@skins = Skin.all
	end	

	def edit
	end

  def show
    @skin = Skin.find(params[:id])
  end

  def update
    @skin = Skin.find(params[:id])
    if @skin.update_attributes(params[:skin])
      redirect_to admin_site_skins_path
    else
      render :action => 'show'
    end
  end

  def create
    @skin = Skin.new(params[:skin])
    @skin.save!
		@skin.unzip_and_process_skin
    redirect_to admin_skins_path
  rescue ActiveRecord::RecordInvalid => invalid
    flash[:error] = invalid.record.errors.full_messages
    render :action => :index
  end
  
  def destroy
    @skin = Skin.find(params[:id])
		File.delete(@skin.archive.path)
		File.delete(@skin.image.path)
		skin_dir = File::join(RAILS_ROOT, "public", "system", "images", @skin.id.to_s)
		#Dir.foreach(skin_dir) { |dir|
		#	next if dir == ".." || "."
		#	Dir.foreach("#{skin_dir}/#{dir}") { |image|
		#		next if image == ".." || "."
		#		File.delete("#{skin_dir}/#{image}")
		#	}
		#	Dir.delete("#{skin_dir}/#{dir}")
		#}		
		#Dir.rmdir(skin_dir)
		FileUtils.rm_r(skin_dir)    
		@skin.destroy
    redirect_to admin_skins_path
  rescue ActiveRecord::RecordNotFound
    flash[:error] = 'The specified Skin could not be found.'
    redirect_to :action => :index
  end

	def activate
		@skin = Skin.find(params[:id])
		@skin.activate_on(current_site, current_user) if current_user.admin? || current_user.site_admin?
		redirect_to admin_layouts_path
	end

	def deactivate
		@skin = Skin.find(params[:id])
		@skin.deactivate_on(current_site)
	end
end
